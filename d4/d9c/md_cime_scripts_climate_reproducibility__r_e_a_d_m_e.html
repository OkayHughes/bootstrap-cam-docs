<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CAM6: Climate reproducibility testing</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CAM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Climate reproducibility testing </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Requiring model changes to pass stringent tests before being accepted as part of E3SM’s main development branch is critical for quickly and efficiently producing a trustworthy model. Depending on their impacts on model output, code modifications can be classified into three types:</p>
<ol type="1">
<li>Technical changes that continue to produce bit-for-bit identical solutions</li>
<li>Changes that cause the model solution to differ, yet produce a statistically identical climate when averaged over a sufficiently long time</li>
<li>Changes that lead to a different model climate</li>
</ol>
<p>Only (3) impacts model climate, and changes of this type should only be implemented within the code after an in-depth demonstration of improvement. However, distinguishing between (2) and (3) requires a comprehensive analysis of both a baseline climate and the currently produced climate. <br  />
</p>
<p>Through the CMDV Software project, we've provided a set of climate reproducibility tests to determine whether or not non-bit-for-bit (nb4b) model changes are climate changing. The current tests provided are:</p>
<ul>
<li><b>MVK</b> &ndash; This tests the null hypothesis that the baseline (n) and modified (m) model Short Independent Simulation Ensembles (SISE) represent the same climate state, based on the equality of distribution of each variable's annual global average in the standard monthly model output between the two simulations. The (per variable) null hypothesis uses the non-parametric, two-sample (n and m) Kolmogorov-Smirnov test as the univariate test of of equality of distribution of global means.</li>
<li><b>PGN</b> &ndash; This tests the null hypothesis that the reference (n) and modified (m) model ensembles represent the same atmospheric state after each physics parameterization is applied within a single time-step using the two-sample (n and m) T-test for equal averages at a 95% confidence level. Ensembles are generated by repeating the simulation for many initial conditions, with each initial condition subject to multiple perturbations.</li>
<li><b>TSC</b> &ndash; This tests the null hypothesis that the convergence of the time stepping error for a set of key atmospheric variables is the same for a reference ensemble and a test ensemble. Both the reference and test ensemble are generated with a two-second time step, and for each variable the RMSD between each ensemble and a truth ensemble, generated with a one-second time step, is calculated. At each 10 second interval during the 10 minute long simulations, the difference in the reference and test RMSDs for each variable, each ensemble member, and each domain are calculated and these ΔRMSDs should be zero for identical climates. A one sided (due to self convergence) Student's T Test is used to test the null hypothesis that the ensemble mean ΔRMSD is statistically zero.</li>
</ul>
<h1><a class="anchor" id="autotoc_md24"></a>
Running the tests</h1>
<p>These tests are built into E3SM-CIME as system tests and will be launched using the <code><a class="el" href="../../d3/df2/namespacecreate__test.html">create_test</a></code> scripts. <em>However</em>, because these tests use high level statistics, they have additional python dependencies which need to be installed on your system and accessible via the compute nodes (if you're on a batch machine). Primarily, the statistical analysis of the climates is done through <a href="https://github.com/LIVVkit/evv4esm">EVV</a> which will generate a portable test website to describe the results (pass or fail) in detail (see the extended output section below).</p>
<p>For E3SM supported machines, the <code>e3sm_simple</code> conda environment is provided for these tests and includes the <code>EVV</code> conda package. You can activate the <code>e3sm_simple</code> environment in the same way as <code>e3sm_unified</code> environment: <br  />
</p>
<div class="fragment"><div class="line">source &lt;activate_path&gt;/load_latest_e3sm_simple.sh</div>
</div><!-- fragment --><p>where <code>&lt;activate_path&gt;</code> is the machine-specific location of the activation script as described on this confluence page:</p>
<p><a href="https://acme-climate.atlassian.net/wiki/spaces/EIDMG/pages/780271950/Diagnostics+and+Analysis+Quickstart#DiagnosticsandAnalysisQuickstart-Accessingmetapackagesoftwarebyactivatingacondaenvironment">https://acme-climate.atlassian.net/wiki/spaces/EIDMG/pages/780271950/Diagnostics+and+Analysis+Quickstart#DiagnosticsandAnalysisQuickstart-Accessingmetapackagesoftwarebyactivatingacondaenvironment</a></p>
<p>If you don't have access to confluence or are unable to activate this environment for whatever reason, you can install your own <code>e3sm_simple</code> conda environment with this command (once you have anaconda/miniconda installed): <br  />
</p>
<div class="fragment"><div class="line">conda create -n e3sm-simple -c conda-forge -c e3sm e3sm-simple</div>
</div><!-- fragment --><p>*NOTE: If you run into problems with getting this environment working on your machine, please open an issue on E3SM's Github and tag @jhkennedy, or send Joseph H. Kennedy <a href="#" onclick="location.href='mai'+'lto:'+'ken'+'ne'+'dyj'+'h@'+'orn'+'l.'+'gov'; return false;">kenne<span class="obfuscator">.nosp@m.</span>dyjh<span class="obfuscator">.nosp@m.</span>@ornl<span class="obfuscator">.nosp@m.</span>.gov</a> an email.*</p>
<p>After you've activated the <code>e3sm_simple</code> environment, change to the <code>$E3SM/cime/scripts</code> directory (where <code>$E3SM</code> is the directory containing E3SM). Then to run one of the tests, you will use the <code><a class="el" href="../../d3/df2/namespacecreate__test.html">create_test</a></code> script like normal. To run the <code>MVK</code> test and generate a baseline, you would run a command like:</p>
<div class="fragment"><div class="line">./create_test MVK_PL.ne4_oQU240.FC5AV1C-L -g --baseline-root &quot;/PATH/TO/BASELINE&quot; </div>
</div><!-- fragment --><p>And to compare to the baseline, you would run a command like:</p>
<div class="fragment"><div class="line">./create_test MVK_PL.ne4_oQU240.FC5AV1C-L -c --baseline-root &quot;/PATH/TO/BASELINE&quot; </div>
</div><!-- fragment --><p><em>NOTE: The MVK run a 20 member ensemble for at least 13 months (using the last 12 for the statistical tests) and, depending on the machine, may take some fiddling to execute within a particular queue's wallclock time limit. You may want to over-ride the requested walltime using <code>--walltime HH:MM:SS</code> option to <code><a class="el" href="../../d3/df2/namespacecreate__test.html">create_test</a></code>.</em></p>
<p>The full set of commands to run the MVK test used on Cori are:</p>
<p><em>Generate a baseline</em> </p><div class="fragment"><div class="line">cd $E3SM/cime/scripts</div>
<div class="line"> </div>
<div class="line">source /global/project/projectdirs/acme/software/anaconda_envs/load_latest_e3sm_simple.sh</div>
<div class="line"> </div>
<div class="line">./create_test MVK_PL.ne4_ne4.FC5AV1C-L --baseline-root &quot;${CSCRATCH}/baselines&quot; --project acme -g -o --walltime 01:00:00</div>
</div><!-- fragment --><p><em>Compare to a baseline</em> </p><div class="fragment"><div class="line">cd $E3SM/cime/scripts</div>
<div class="line"> </div>
<div class="line">source /global/project/projectdirs/acme/software/anaconda_envs/load_latest_e3sm_simple.sh</div>
<div class="line"> </div>
<div class="line">./create_test MVK_PL.ne4_ne4.FC5AV1C-L --baseline-root &quot;${CSCRATCH}/baselines&quot; --project acme -c --walltime 01:00:00</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md25"></a>
Test pass/fail and extended output</h1>
<p>When you launch these tests and compare to a baseline, <a class="el" href="../../d5/dc4/namespace_c_i_m_e.html">CIME</a> will output the location of the case directory, which will look something like this:</p>
<div class="fragment"><div class="line"># On cori-knl:</div>
<div class="line">./create_test MVK_PL.ne4_ne4.FC5AV1C-L --baseline-root &quot;${CSCRATCH}/baselines&quot; --project acme -c --walltime 01:00:00</div>
<div class="line">    Creating test directory /global/cscratch1/sd/${USER}/acme_scratch/cori-knl/MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID</div>
</div><!-- fragment --><p>Let's call that directory <code>$CASE_DIR</code>. Once all the jobs are finished, navigate to that directory and you can <code>cat TestStatus</code> to determine if the test passed or failed by looking at the <code>BASELINE</code> status: <br  />
</p>
<div class="fragment"><div class="line">cd $CASE_DIR</div>
<div class="line">cat TestStatus</div>
<div class="line">    ...</div>
<div class="line">    PASS MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel BASELINE</div>
<div class="line">    ...</div>
</div><!-- fragment --><p>To get some basic summary statistics about the test that was run, look in the <code>TestStatus.log</code> file:</p>
<div class="fragment"><div class="line">2019-08-14  22:09:02: BASELINE PASS for test &#39;YYYYMMDD_HHMMSS_RANDOMID&#39;. </div>
<div class="line">    Case: YYYYMMDD_HHMMSS_RANDOMID; Test status: pass; Variables analyzed: 118; Rejecting: 0; Critical value: 13; Ensembles: statistically identical </div>
<div class="line">    EVV results can be viewed at: /global/cscratch1/sd/${USER}/acme_scratch/cori-knl/MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID/run/MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID.evv/ </div>
<div class="line">    EVV viewing instructions can be found at: https://github.com/E3SM-Project/E3SM/blob/master/cime/scripts/climate_reproducibility/README.md#test-passfail-and-extended-output </div>
</div><!-- fragment --><p>EVV reports the location of the output website where you can see the details of the analysis. For the MVK test, you will be able to view per variable Q-Q plots, P-P plots, the K-S test statistic, and whether it rejects or accepts the null hypothesis, as well as a description of the test itself &ndash; you can see an example of the output website <a href="http://livvkit.github.io/evv4esm/">here</a>.</p>
<p>To view the website, you can either tunnel the website to your local machine through ssh, or copy the website directory to your machine and view it using EVV.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
View via ssh</h2>
<p>For this example, we'll assume the tests were run on Cori at NERSC, but these instructions should be easily adaptable to any E3SM supported machine. First, log into Cori via ssh and connect your local 8080 port to the 8080 port on Cori:</p>
<div class="fragment"><div class="line">ssh -L 8080:localhost:8080 [USER]@cori.nersc.gov </div>
</div><!-- fragment --><p>Activate the <code>e3sm_simple</code> environment:</p>
<div class="fragment"><div class="line">source /global/project/projectdirs/acme/software/anaconda_envs/load_latest_e3sm_simple.sh</div>
</div><!-- fragment --><p>Navigate to the case's run directory:</p>
<div class="fragment"><div class="line">pushd ${CASE_DIR}/run</div>
</div><!-- fragment --><p>Then, using EVV, serve the website over port 8080:</p>
<div class="fragment"><div class="line">evv -o PGN_P1x1.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID.evv -s 8080</div>
</div><!-- fragment --><p>Evv will then report to you the URL where you can view the website:</p>
<div class="fragment"><div class="line">--------------------------------------------------------------------</div>
<div class="line">                   ______  __      __ __      __                    </div>
<div class="line">                  |  ____| \ \    / / \ \    / /                    </div>
<div class="line">                  | |__     \ \  / /   \ \  / /                     </div>
<div class="line">                  |  __|     \ \/ /     \ \/ /                      </div>
<div class="line">                  | |____     \  /       \  /                       </div>
<div class="line">                  |______|     \/         \/                        </div>
<div class="line">                                                                    </div>
<div class="line">    Extended Verification and Validation for Earth System Models    </div>
<div class="line">--------------------------------------------------------------------</div>
<div class="line"> </div>
<div class="line">  Current run: 2019-08-27 14:16:49</div>
<div class="line">  User: kennedyj</div>
<div class="line">  OS Type: Linux 4.12.14-150.27-default</div>
<div class="line">  Machine: cori07</div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">Serving HTTP on 0.0.0.0 port 8080 (http://0.0.0.0:8080/)</div>
<div class="line"> </div>
<div class="line">View the generated website by navigating to:</div>
<div class="line"> </div>
<div class="line">    http://0.0.0.0:8080/PGN_P1x1.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID.evv/index.html</div>
<div class="line"> </div>
<div class="line">Exit by pressing `ctrl+c` to send a keyboard interrupt.</div>
</div><!-- fragment --><p>You can now either click that link or copy-paste that link into your favorite web browser to view the output website.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
View a local copy</h2>
<p>For this example, we'll assume the tests were run on Cori at NERSC, but these instructions should be easily adaptable to any E3SM supported machine. Install <code>e3sm_simple</code> locally and activate it:</p>
<div class="fragment"><div class="line">conda create -n e3sm_simple -c conda-forge -c e3sm e3sm-simple</div>
<div class="line">conda activate e3sm_simple</div>
</div><!-- fragment --><p>Then, copy the website to your local machine, and view it:</p>
<div class="fragment"><div class="line"># on your local machine</div>
<div class="line">scp -r /global/cscratch1/sd/${USER}/acme_scratch/cori-knl/MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID/run/MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID.evv . </div>
<div class="line">evv -o MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID.evv -s</div>
<div class="line">    --------------------------------------------------------------------</div>
<div class="line">                       ______  __      __ __      __                    </div>
<div class="line">                      |  ____| \ \    / / \ \    / /                    </div>
<div class="line">                      | |__     \ \  / /   \ \  / /                     </div>
<div class="line">                      |  __|     \ \/ /     \ \/ /                      </div>
<div class="line">                      | |____     \  /       \  /                       </div>
<div class="line">                      |______|     \/         \/                        </div>
<div class="line">                                                                        </div>
<div class="line">        Extended Verification and Validation for Earth System Models    </div>
<div class="line">    --------------------------------------------------------------------</div>
<div class="line">    </div>
<div class="line">      Current run: 2018-08-06 15:15:03</div>
<div class="line">      User: ${USER}</div>
<div class="line">      OS Type: Linux 4.15.0-29-generic</div>
<div class="line">      Machine: pc0101123</div>
<div class="line">      </div>
<div class="line">    </div>
<div class="line">    Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/)</div>
<div class="line">    </div>
<div class="line">    View the generated website by navigating to:</div>
<div class="line">    </div>
<div class="line">        http://0.0.0.0:8000/MVK_PL.ne4_ne4.FC5AV1C-L.cori-knl_intel.C.YYYYMMDD_HHMMSS_RANDOMID.evv/index.html</div>
<div class="line">    </div>
<div class="line">    Exit by pressing `ctrl+c` to send a keyboard interrupt.</div>
</div><!-- fragment --><p>You can now either click that link or copy-paste that link into your favorite web browser to view the output website.</p>
<p><b>Please note:</b> the output website uses some JavaScript to render elements of the page (especially figures), and opening up the <code>index.html</code> file using the <code><a href="file://">file://</a></code> protocol in a web browser will likely not work well (most browser have stopped allowing access to "local resources" like JavaScript through the <code><a href="file://">file://</a></code> protocol). You can view the website by either copying it to a hosted location (<code>~/WWW</code> which is hosted at <code><a href="http://users.nccs.gov/~user">http://users.nccs.gov/~user</a></code> on Titan, for example) or copying it to your local machine and running a local http server (included in python!) and viewing it through an address like <code><a href="http://0.0.0.0:8000/index.html">http://0.0.0.0:8000/index.html</a></code>. <br  />
 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
