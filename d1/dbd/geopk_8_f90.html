<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CAM6: src/dynamics/fv/geopk.F90 File Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CAM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="../../dir_261425c25055ac4a48b7253766e15e1a.html">dynamics</a></li><li class="navelem"><a class="el" href="../../dir_449e19a98f3075c1ec1167d7fb05e337.html">fv</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle"><div class="title">geopk.F90 File Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a5961fe5ed1cedbe60fcbdc97623f0ac2"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dbd/geopk_8_f90.html#a5961fe5ed1cedbe60fcbdc97623f0ac2">DSIZE</a>&#160;&#160;&#160;8</td></tr>
<tr class="separator:a5961fe5ed1cedbe60fcbdc97623f0ac2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a50a6ee2f0f7f26eeba38ba9ae90ed088"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dbd/geopk_8_f90.html#a50a6ee2f0f7f26eeba38ba9ae90ed088">DTWO</a>&#160;&#160;&#160;1</td></tr>
<tr class="separator:a50a6ee2f0f7f26eeba38ba9ae90ed088"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a26e0c5d8cc5d1b61ea961689c9bf8239"><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/dbd/geopk_8_f90.html#a26e0c5d8cc5d1b61ea961689c9bf8239">geopk</a> (grid, pe, delp, pk, wz, hs, pt, cp3v, cap3v, nx)</td></tr>
<tr class="separator:a26e0c5d8cc5d1b61ea961689c9bf8239"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a5961fe5ed1cedbe60fcbdc97623f0ac2" name="a5961fe5ed1cedbe60fcbdc97623f0ac2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5961fe5ed1cedbe60fcbdc97623f0ac2">&#9670;&#160;</a></span>DSIZE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DSIZE&#160;&#160;&#160;8</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="a50a6ee2f0f7f26eeba38ba9ae90ed088" name="a50a6ee2f0f7f26eeba38ba9ae90ed088"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a50a6ee2f0f7f26eeba38ba9ae90ed088">&#9670;&#160;</a></span>DTWO</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DTWO&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a26e0c5d8cc5d1b61ea961689c9bf8239" name="a26e0c5d8cc5d1b61ea961689c9bf8239"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a26e0c5d8cc5d1b61ea961689c9bf8239">&#9670;&#160;</a></span>geopk()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine geopk </td>
          <td>(</td>
          <td class="paramtype">type (<a class="el" href="../../d7/db0/structdynamics__vars_1_1t__fvdycore__grid.html">t_fvdycore_grid</a>), intent(in)&#160;</td>
          <td class="paramname"><em>grid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>pe</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>delp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>pk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>wz</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>hs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(r8), <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a26822f45fa1167a47dacf14152ba0e3c">dimension</a>(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jla 
      real(r8)    cap3v(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jl 
      real(r8)    hs(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jlast 
      real(r8)    pt(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jlast 
      real(r8)  delp(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jlast 

! !output parameters:
      real(r8) wz(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jlastxy, 
      real(r8) pk(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jlastxy, 
      real(r8) <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(grid%ifirstxy:grid%ilastxy,grid%km+1,grid%jfirstxy:gri 

! !description:
!     calculates geopotential and <a class="el" href="../../d7/ddc/crmx__pressure_8_f90.html#abadaf84c2c16f1e8d36fa88905849f84">pressure</a> to the kappa.  this is an expensive
!     operation and several <a class="el" href="../../dd/d81/trilinos_linear_solver_8cpp.html#accde5065416d529b6bdaf7a813644529">out</a> arrays are kept around for future use.
!
! !revision history:
!
!  ws  99.10.22: mpied sj'<a class="el" href="../../df/d2e/verif_a_e_8m.html#afbe9f62a5b71779115b4c4010fd8a89c">s</a> original smp version
!  sjl 00.01.01: merged c-core and d-core computation
!                smp &quot;decmposition&quot; in e-w by combining <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> and <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> loops
!  ws  00.12.01: replaced mpi_on with spmd; hs <a class="el" href="../../dd/d47/mpp__write__compressed_8h.html#ab92a663e45d74b6c37ad95915b29626b">now</a> distributed
!  aam 01.06.27: generalize for 2d decomposition
!  aam 01.07.24: removed dpcheck
!  ws  04.10.07: simplified <a class="el" href="../../dd/d81/trilinos_linear_solver_8cpp.html#ae6deea6e7d03b5d4db98ea209159e57f">interface</a> using grid as input argument
!  ws  05.05.25: merged cam and geos5 versions (mostly cam)
!
!eop
!---------------------------------------------------------------------
!boc

! local:
      real(r8), <a class="el" href="../../d3/d2b/mpif_8h.html#a6ac3ddb70a66589a330efa9f6d41bdbb">parameter</a> ::  d0_0                    =  0.0_r8
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: im, jm, km, jfirst, jlast, ifirst, ilast
      real(r8) :: ptop

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> ixj, jp, it, i1, i2, nxu, itot
      real(r8) delpp(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jlast 
      real(r8) cap3vi(grid%ifirstxy:grid%ilastxy,grid%jfirstxy:grid%jlas 
      real(r8) peln(grid%ifirstxy:grid%ilastxy,grid%km+1,grid%jfirstxy:g 

      logical :: high_alt
      high_alt = grid%high_alt

      ptop = grid%ptop
      im = grid%im
      jm = grid%jm
      km = grid%km
      ifirst = grid%ifirstxy
      ilast  = grid%ilastxy
      jfirst = grid%jfirstxy
      jlast  = grid%jlastxy

      itot = ilast - ifirst + 1
!     nxu = nx
      nxu = 1
      it = itot / nxu
      jp = nxu * ( jlast - jfirst + 1 )

      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (grid%high_alt) then
!$omp parallel do private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
         do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>=2,km
            do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>=grid%jfirstxy,grid%jlastxy
               do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=grid%ifirstxy,grid%ilastxy
                  cap3vi(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = 0.5_r8*(cap3v(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1)+cap3v(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>))
               enddo
            enddo
         enddo
         cap3vi(:,:,1) = 1.5_r8 * cap3v(:,:,1) - 0.5_r8 * cap3v(:,:,2)
         cap3vi(:,:,km+1) = 1.5_r8 * cap3v(:,:,km) - 0.5_r8 * cap3v(:,:, 
      <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
         cap3vi(:,:,:) =  cap3v(grid%ifirstxy,grid%jfirstxy,1)
      endif

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(i1, i2, ixj, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> )

!     do 2000 <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>=jfirst,jlast
      do 2000 ixj=1, jp

         <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>  = jfirst + (ixj-1)/nxu
         i1 = ifirst + it * mod(ixj-1, nxu)
         i2 = i1 + it - 1

         do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=i1,i2
            <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,1,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>) = d0_0
            wz(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,km+1) = d0_0
         enddo

! top down
         do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>=2,km+1
            do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=i1,i2
               <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>)  = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>) + delp(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1)
            enddo
         enddo
         do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>=1,km+1
            do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=i1,i2
               <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>)  = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>) + ptop
               peln(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>) = log(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>))
               pk(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>)**cap3vi(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
            enddo
         enddo

! bottom up
         <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (high_alt) then
            do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>=1,km
               do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=i1,i2
                  delpp(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = cp3v(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)*cap3v(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)*pt(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)*pk(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> 
               enddo
            enddo
         <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
            do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>=1,km
               do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=i1,i2
                  delpp(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = cp3v(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)*pt(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)*(pk(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>+1)-pk(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> 
               enddo
            enddo
         endif

         do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>=km,1,-1
            do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=i1,i2
               wz(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = wz(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>+1)+delpp(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
            enddo
         enddo
         do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>=1,km+1
            do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=i1,i2
               wz(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = wz(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)+hs(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>)
            enddo
         enddo
      continue

      <a class="el" href="../../da/dae/verif_d_8m.html#ad88990eaa4ee2ac6919ddc68ea9617ad">return</a>
!eoc
      <a class="el" href="../../dd/dba/verif_bu_8m.html#af5dc6e45ec0e66069f2846df5acf1026">end</a> subroutine geopk
!-----------------------------------------------------------------------


!-----------------------------------------------------------------------
!bop
! !routine: geopk16 --- calculate geopotential to the kappa
!
! !interface:
      subroutine geopk16(grid, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>, delp, pk, wz, hs, pt, ng, cp, akap )

      use shr_kind_mod,  only : r8 =&gt; shr_kind_r8, i8 =&gt; shr_kind_i8
      use decompmodule,  only : decomptype
      use dynamics_vars, only : <a class="el" href="../../d7/db0/structdynamics__vars_1_1t__fvdycore__grid.html">t_fvdycore_grid</a>

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined( spmd )
      use parutilitiesmodule, only : parexchangevector
      use mod_comm, only : blockdescriptor, get_partneroffset,      &amp;
                           mp_sendirr, mp_recvirr, max_nparcels
!endif

      implicit none

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined ( spmd )
!include &quot;mpif.h&quot;
!endif

! !input parameters:

      type (<a class="el" href="../../d7/db0/structdynamics__vars_1_1t__fvdycore__grid.html">t_fvdycore_grid</a>), intent(in) :: grid
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a>, intent(in)  :: ng      ! halo <a class="el" href="../../db/d50/mpi_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a> (<a class="el" href="../../d3/d3d/drifters__compute__k_8h.html#aaf68b4e8e89dfb379b579e345c00dbd0">not</a> always = ng_d)

      real(r8)    akap, cp
      real(r8)    hs(1:grid%im,grid%jfirst:grid%jlast)

! !input parameters:
      real(r8)    pt(1:grid%im,grid%jfirst-ng:grid%jlast+ng,grid%kfirst: 
      real(r8)  delp(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> 

! !output parameters:
      real(r8) wz(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%klas 
      real(r8) pk(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%klas 
      real(r8) <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(1:grid%im,grid%kfirst:grid%klast+1,grid%jfirst:grid%jl 

! !description:
!     calculates geopotential and <a class="el" href="../../d7/ddc/crmx__pressure_8_f90.html#abadaf84c2c16f1e8d36fa88905849f84">pressure</a> to the kappa.  this is an expensive
!     operation and several <a class="el" href="../../dd/d81/trilinos_linear_solver_8cpp.html#accde5065416d529b6bdaf7a813644529">out</a> arrays are kept around for future use.
!     to preserve accuracy through round-off, 16-byte reals are used
!     for some intermediate data.
!
! !revision history:
!
!  aam 00.12.18: original version
!  aam 03.01.21: use mod_comm
!  ws  03.11.19: merged latest cam version (by aam)
!  ws  04.10.07: simplified <a class="el" href="../../dd/d81/trilinos_linear_solver_8cpp.html#ae6deea6e7d03b5d4db98ea209159e57f">interface</a> using grid as input argument
!  ws  05.05.17: merged cam and geos5 versions
!
!eop
!---------------------------------------------------------------------
!boc

!ifndef no_cray_pointers

! local:
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>, nk, ijtot, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>, ione

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: im,jm,km, ifirst, ilast, jfirst, jlast, kfirst, klast
      real(r8):: ptop

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: npr_y, npr_z, npes_yz, myid_y, myid_z
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: twod_decomp, mod_geopk

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (dsize == 16)
!ifdef no_r16
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a>,<a class="el" href="../../d3/d2b/mpif_8h.html#a6ac3ddb70a66589a330efa9f6d41bdbb">parameter</a> :: r16= selected_real_kind(12) ! 8 byte real
!<a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a>,<a class="el" href="../../d3/d2b/mpif_8h.html#a6ac3ddb70a66589a330efa9f6d41bdbb">parameter</a> :: r16= selected_real_kind(24) ! 16 byte real
!endif
      real(r16), <a class="el" href="../../d3/d2b/mpif_8h.html#a6ac3ddb70a66589a330efa9f6d41bdbb">parameter</a> ::  dp0_0                    =  0.0_r16
      real(r16)  delp16(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:gri 
      real(r16)  pe16(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid% 
      real(r16)  <a class="el" href="../../d1/d7d/pack_8c.html#a60fcf9bed99474ec217099138b4b3b65">inbuf</a>(1:grid%im,grid%jfirst:grid%jlast,0:grid%npr_z-1)
      real(r16)  <a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>(1:grid%im,grid%jfirst:grid%jlast,0:grid%npr_z-1)
!<a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
      real (r8), <a class="el" href="../../d3/d2b/mpif_8h.html#a6ac3ddb70a66589a330efa9f6d41bdbb">parameter</a> ::  dp0_0                    =  0.0_r8
      real (r8) delp16(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid 
      real (r8) pe16(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> 
      real (r8) <a class="el" href="../../d1/d7d/pack_8c.html#a60fcf9bed99474ec217099138b4b3b65">inbuf</a>(1:grid%im,grid%jfirst:grid%jlast,0:grid%npr_z-1)
      real (r8) <a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>(1:grid%im,grid%jfirst:grid%jlast,0:grid%npr_z-1)
!endif
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>(0:grid%npr_z-1), <a class="el" href="../../d1/dcd/collective_8c.html#ade44820842cbf0a3f0bb32deea7a1103">recvcount</a>(0:grid%npr_z-1)

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined(spmd)
!
! data structures for mp_sendirr, mp_recvirr
!
      type (blockdescriptor), <a class="el" href="../../de/dac/mpp__write__unlimited__axis_8h.html#ac353729cf971070612d112992761dc0e">allocatable</a>, save :: sendbl1(:), recvbl1(: 
      type (blockdescriptor), <a class="el" href="../../de/dac/mpp__write__unlimited__axis_8h.html#ac353729cf971070612d112992761dc0e">allocatable</a>, save :: sendbl2(:), recvbl2(: 

!endif

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> first_time_through
      data first_time_through / 0 /

! arrays inbuf8 and outbuf8 are created to fool the compiler
!  into accepting them as calling arguments for parexchangevector.
!  the trickery below equivalences them to <a class="el" href="../../d1/d7d/pack_8c.html#a60fcf9bed99474ec217099138b4b3b65">inbuf</a> and <a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>
      real (r8) inbuf8(1), outbuf8(1)
      pointer (ptr_inbuf8, inbuf8)
      pointer (ptr_outbuf8, outbuf8)
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> (i8) locinbuf, locoutbuf

!
! initialize variables from grid
!
      ptop = grid%ptop

      im       = grid%im
      jm       = grid%jm
      km       = grid%km

      ifirst   = 1               ! 2004.10.04 (ws): <a class="el" href="../../dd/d47/mpp__write__compressed_8h.html#ab92a663e45d74b6c37ad95915b29626b">now</a> hardwired for 1..im
      ilast    = grid%im         ! code was always used in this mode 
      jfirst   = grid%jfirst
      jlast    = grid%jlast
      kfirst   = grid%kfirst
      klast    = grid%klast

      myid_y = grid%myid_y
      myid_z = grid%myid_z

      npr_y   = grid%npr_y
      npr_z   = grid%npr_z
      npes_yz = grid%npes_yz

      twod_decomp = grid%twod_decomp
      mod_geopk   = grid%mod_geopk

      ijtot = (jlast-jfirst+1) * (ilast-ifirst+1)

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (first_time_through .eq. 0) then
       first_time_through = 1
       ione = 1
       <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (npr_z .gt. 1) then
        allocate( sendbl1(0:npes_yz-1) )
        allocate( recvbl1(0:npes_yz-1) )
        allocate( sendbl2(0:npes_yz-1) )
        allocate( recvbl2(0:npes_yz-1) )

        do nk = 0,npes_yz-1

          sendbl1(nk)%method = mod_geopk
          sendbl2(nk)%method = mod_geopk
          recvbl1(nk)%method = mod_geopk
          recvbl2(nk)%method = mod_geopk

! allocate for either method (safety)
          allocate( sendbl1(nk)%blocksizes(1) )
          allocate( sendbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) )
          allocate( recvbl1(nk)%blocksizes(1) )
          allocate( recvbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) )
          allocate( sendbl2(nk)%blocksizes(1) )
          allocate( sendbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) )
          allocate( recvbl2(nk)%blocksizes(1) )
          allocate( recvbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) )

          sendbl1(nk)%type = mpi_datatype_null

          <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> ( (nk/npr_y) &gt; myid_z .and. mod(nk,npr_y) == myid_y ) then 

             <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (mod_geopk .ne. 0) then
                call mpi_type_indexed(ione, dtwo*ijtot,   &amp;
                     dtwo*ijtot*(klast-kfirst+1), mpi_double_precision,  
                     sendbl1(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
                call mpi_type_commit(sendbl1(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
             endif

             sendbl1(nk)%blocksizes(1) = dtwo*ijtot
             sendbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = dtwo*ijtot*(klast-kfirst+1)
             sendbl1(nk)%partneroffset = myid_z * ijtot * dtwo

          <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>

             sendbl1(nk)%blocksizes(1) = 0
             sendbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = 0
             sendbl1(nk)%partneroffset = 0

          endif
          sendbl1(nk)%nparcels = <a class="el" href="../../db/d50/mpi_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>(sendbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>)
          sendbl1(nk)%tot_size = sum(sendbl1(nk)%blocksizes)
          max_nparcels = <a class="el" href="../../d6/d4d/pio__internal_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(max_nparcels, sendbl1(nk)%nparcels)

          recvbl1(nk)%type = mpi_datatype_null

          <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> ( (nk/npr_y) &lt; myid_z .and. mod(nk,npr_y) == myid_y ) then

             <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (mod_geopk .ne. 0) then
                call mpi_type_indexed(ione, dtwo*ijtot,   &amp;
                     nk/npr_y * ijtot * dtwo, mpi_double_precision, &amp;
                     recvbl1(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
                call mpi_type_commit(recvbl1(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
             endif

             recvbl1(nk)%blocksizes(1) = dtwo*ijtot
             recvbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = nk/npr_y * ijtot * dtwo
             recvbl1(nk)%partneroffset = 0

          <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>

             recvbl1(nk)%blocksizes(1) = 0
             recvbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = 0
             recvbl1(nk)%partneroffset = 0

          endif
          recvbl1(nk)%nparcels = <a class="el" href="../../db/d50/mpi_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>(recvbl1(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>)
          recvbl1(nk)%tot_size = sum(recvbl1(nk)%blocksizes)
          max_nparcels = <a class="el" href="../../d6/d4d/pio__internal_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(max_nparcels, recvbl1(nk)%nparcels)

          <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> ( (nk/npr_y) &lt; myid_z .and. mod(nk,npr_y) == myid_y ) then 

             call mpi_type_indexed(ione, dtwo*ijtot,   &amp;
                  0, mpi_double_precision, &amp;
                  sendbl2(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
             call mpi_type_commit(sendbl2(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)

             sendbl2(nk)%blocksizes(1) = dtwo*ijtot
             sendbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = 0
             sendbl2(nk)%partneroffset = (myid_z-nk/npr_y-1) * ijtot * d 

          <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>

             sendbl2(nk)%type = mpi_datatype_null

             sendbl2(nk)%blocksizes(1) = 0
             sendbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = 0
             sendbl2(nk)%partneroffset = 0

          endif
          sendbl2(nk)%nparcels = <a class="el" href="../../db/d50/mpi_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>(sendbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>)
          sendbl2(nk)%tot_size = sum(sendbl2(nk)%blocksizes)
          max_nparcels = <a class="el" href="../../d6/d4d/pio__internal_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(max_nparcels, sendbl2(nk)%nparcels)

          <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> ( (nk/npr_y) &gt; myid_z .and. mod(nk,npr_y) == myid_y ) then

             call mpi_type_indexed(ione, dtwo*ijtot,   &amp;
                  nk/npr_y * ijtot * dtwo, mpi_double_precision, &amp;
                  recvbl2(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
             call mpi_type_commit(recvbl2(nk)%type, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)

             recvbl2(nk)%blocksizes(1) = dtwo*ijtot
             recvbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = nk/npr_y * ijtot * dtwo
             recvbl2(nk)%partneroffset = 0

          <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>

             recvbl2(nk)%type = mpi_datatype_null

             recvbl2(nk)%blocksizes(1) = 0
             recvbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>(1) = 0
             recvbl2(nk)%partneroffset = 0

          endif
          recvbl2(nk)%nparcels = <a class="el" href="../../db/d50/mpi_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>(recvbl2(nk)%<a class="el" href="../../de/ddc/type_8c.html#aaba348d1425508c7fb9382069202720b">displacements</a>)
          recvbl2(nk)%tot_size = sum(recvbl2(nk)%blocksizes)
          max_nparcels = <a class="el" href="../../d6/d4d/pio__internal_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(max_nparcels, recvbl2(nk)%nparcels)
        enddo

        call get_partneroffset(grid%commyz, sendbl1, recvbl1)
        call get_partneroffset(grid%commyz, sendbl2, recvbl2)

       endif
      endif

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (!defined parexch)
      locinbuf = loc(pe16)
!<a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
      locinbuf = loc(<a class="el" href="../../d1/d7d/pack_8c.html#a60fcf9bed99474ec217099138b4b3b65">inbuf</a>)
!endif
      locoutbuf = loc(<a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>)
      ptr_inbuf8 = locinbuf
      ptr_outbuf8 = locoutbuf
!endif

! top down

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (dsize == 16)
!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
      do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
         delp16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = delp(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
      enddo
      enddo
      enddo
!endif

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>)
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
        pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,kfirst) = dp0_0
      enddo
      enddo

! compute partial sums

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
        do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst+1,klast+1
        do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (dsize == 16)
          pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1) + delp16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1)
!<a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
          pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1) + delp(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1)
!endif
        enddo
        enddo
      enddo

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined( spmd )
      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (npr_z .gt. 1) then

! communicate upward

! <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> !defined (parexch)
        call mp_sendirr(grid%commyz, sendbl1, recvbl1, inbuf8, outbuf8,             
                        modc=grid%modc_cdcore )
        call mp_recvirr(grid%commyz, sendbl1, recvbl1, inbuf8, outbuf8,             
                        modc=grid%modc_cdcore )
! <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>

        do nk = 0, npr_z-1
          <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>(nk) = 0
          <a class="el" href="../../d1/dcd/collective_8c.html#ade44820842cbf0a3f0bb32deea7a1103">recvcount</a>(nk) = 0
        enddo

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, nk)
        do nk = myid_z+1, npr_z-1
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
            <a class="el" href="../../d1/d7d/pack_8c.html#a60fcf9bed99474ec217099138b4b3b65">inbuf</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,nk-myid_z-1) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,klast+1)
          enddo
          enddo
! double <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a> since quantities are 16-bytes long
          <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>(nk) = dtwo*ijtot
        enddo

        call parexchangevector(grid%comm_z, <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>, inbuf8, <a class="el" href="../../d1/dcd/collective_8c.html#ade44820842cbf0a3f0bb32deea7a1103">recvcount</a> 

! endif

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>, nk)
        do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast+1
          do nk = 0, myid_z-1
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
             pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) + <a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,nk)
          enddo
          enddo
          enddo
        enddo

      endif
!endif

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
      do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast+1
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
        <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) + ptop
        pk(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>) ** akap
      enddo
      enddo
      enddo

! bottom up

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
      do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
        delp16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = cp*pt(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)*(pk(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>+1)-pk(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>))
      enddo
      enddo
      enddo

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>)
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
        pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,klast+1) = dp0_0
      enddo
      enddo

! compute partial sums

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
        do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = klast,kfirst,-1
        do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
          pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>+1) + delp16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
        enddo
        enddo
      enddo

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined( spmd )
      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (npr_z .gt. 1) then

! communicate downward

! <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> !defined (parexch)
        call mp_sendirr(grid%commyz, sendbl2, recvbl2, inbuf8, outbuf8,             
                        modc=grid%modc_cdcore )
        call mp_recvirr(grid%commyz, sendbl2, recvbl2, inbuf8, outbuf8,             
                        modc=grid%modc_cdcore )
! <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>

        do nk = 0, npr_z-1
          <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>(nk) = 0
          <a class="el" href="../../d1/dcd/collective_8c.html#ade44820842cbf0a3f0bb32deea7a1103">recvcount</a>(nk) = 0
        enddo

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, nk)
        do nk = 0, myid_z-1
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
            <a class="el" href="../../d1/d7d/pack_8c.html#a60fcf9bed99474ec217099138b4b3b65">inbuf</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,nk) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,kfirst)
          enddo
          enddo
! double <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a> since quantities are 16-bytes long
          <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>(nk) = dtwo*ijtot
        enddo

        call parexchangevector(grid%comm_z, <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>, inbuf8, <a class="el" href="../../d1/dcd/collective_8c.html#ade44820842cbf0a3f0bb32deea7a1103">recvcount</a> 

! endif

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>, nk)
        do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast+1
          do nk = myid_z+1, npr_z-1
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
          do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
! <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> !defined (parexch)
            pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) + <a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,nk)
! <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
            pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) + <a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,nk-myid_z-1)
! endif
          enddo
          enddo
          enddo
        enddo

      endif
!endif

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
      do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast+1
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a> = jfirst,jlast
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a> = ifirst,ilast
        wz(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = pe16(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) + hs(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>)
      enddo
      enddo
      enddo

      <a class="el" href="../../da/dae/verif_d_8m.html#ad88990eaa4ee2ac6919ddc68ea9617ad">return</a>
! endif for no_cray_pointers
!endif
!eoc
      <a class="el" href="../../dd/dba/verif_bu_8m.html#af5dc6e45ec0e66069f2846df5acf1026">end</a> subroutine geopk16
!-----------------------------------------------------------------------

!-----------------------------------------------------------------------
!bop
! !routine: geopk_d --- calculate geopotential to the kappa
!
! !interface:
      subroutine geopk_d( grid, <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>, delp, pk, wz, hs, pt, ng, cp, akap )

      use shr_kind_mod,  only : r8 =&gt; shr_kind_r8, i8 =&gt; shr_kind_i8
      use dynamics_vars, only : <a class="el" href="../../d7/db0/structdynamics__vars_1_1t__fvdycore__grid.html">t_fvdycore_grid</a>

      implicit none

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined ( spmd )
!include &quot;mpif.h&quot;
!endif

! !input parameters:

      type (<a class="el" href="../../d7/db0/structdynamics__vars_1_1t__fvdycore__grid.html">t_fvdycore_grid</a>), intent(in) :: grid
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a>, intent(in)  :: ng      ! halo <a class="el" href="../../db/d50/mpi_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a> (<a class="el" href="../../d3/d3d/drifters__compute__k_8h.html#aaf68b4e8e89dfb379b579e345c00dbd0">not</a> always = ng_d)

      real(r8)    akap, cp
      real(r8)    hs(1:grid%im,grid%jfirst:grid%jlast)

! !input parameters:
      real(r8)    pt(1:grid%im,grid%jfirst-ng:grid%jlast+ng,grid%kfirst: 
      real(r8)  delp(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> 

! !output parameters:
      real(r8) wz(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%klas 
      real(r8) pk(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%klas 
      real(r8) <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(1:grid%im,grid%kfirst:grid%klast+1,grid%jfirst:grid%jl 

! !description:
!     calculates geopotential and <a class="el" href="../../d7/ddc/crmx__pressure_8_f90.html#abadaf84c2c16f1e8d36fa88905849f84">pressure</a> to the kappa.  this is an expensive
!     operation and several <a class="el" href="../../dd/d81/trilinos_linear_solver_8cpp.html#accde5065416d529b6bdaf7a813644529">out</a> arrays are kept around for future use.
!     to preserve reproducibility, ordering of transposed-based geopk algorithm
!     is preserved at the cost of a serialization of computation in the z-direction.
!
! !revision history:
!
!  pw  08.06.27: original: simple ring r8 version of geopk16 - 
!                  serialized z-direction but minimized communication overhead
!
!eop
!---------------------------------------------------------------------
!boc

! local:
      real(r8):: ptop
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: km, ifirst, ilast, jfirst, jlast, kfirst, klast
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: npr_z

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: itot, jtot

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: n_blocks
      logical :: sendd   

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>, il, ilmax, ib, iblksiz
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>, jl, jlmax, jb, jblksiz
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>, block, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> :: klimits(2), klimits_all(2,0:grid%npr_z-1)
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a>, save :: k_succ_pid, k_pred_pid

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a>, <a class="el" href="../../de/dac/mpp__write__unlimited__axis_8h.html#ac353729cf971070612d112992761dc0e">allocatable</a> :: rcvreq(:), sndreq(:)

      real (r8), <a class="el" href="../../d3/d2b/mpif_8h.html#a6ac3ddb70a66589a330efa9f6d41bdbb">parameter</a> ::  dp0_0                    =  0.0_r8
      real (r8) l_pe(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid%<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> 
      real (r8) l_delp(1:grid%im,grid%jfirst:grid%jlast,grid%kfirst:grid 

      real (r8) <a class="el" href="../../d1/d7d/pack_8c.html#a60fcf9bed99474ec217099138b4b3b65">inbuf</a>(1:grid%im,grid%jfirst:grid%jlast,0:grid%npr_z-1)
      real (r8) <a class="el" href="../../d1/d7d/pack_8c.html#a01d7c177e070959afacde7a750ef0fd7">outbuf</a>(1:grid%im,grid%jfirst:grid%jlast,0:grid%npr_z-1)
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> <a class="el" href="../../d1/dcd/collective_8c.html#a32ef518241cc2bc92535d91d40934a8c">sendcount</a>(0:grid%npr_z-1), <a class="el" href="../../d1/dcd/collective_8c.html#ade44820842cbf0a3f0bb32deea7a1103">recvcount</a>(0:grid%npr_z-1)

      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> first_time_through
      data first_time_through / 0 /

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined ( spmd )
      <a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a> status (mpi_status_size) ! status of message
!endif

!
! initialize variables from grid
!
      ptop     = grid%ptop

      km       = grid%km

      ifirst   = 1               ! 2004.10.04 (ws): <a class="el" href="../../dd/d47/mpp__write__compressed_8h.html#ab92a663e45d74b6c37ad95915b29626b">now</a> hardwired for 1..im
      ilast    = grid%im         ! code was always used in this mode 
      jfirst   = grid%jfirst
      jlast    = grid%jlast
      kfirst   = grid%kfirst
      klast    = grid%klast

      npr_z = grid%npr_z

      itot  = (ilast-ifirst+1)
      jtot  = (jlast-jfirst+1)

      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (grid%modc_cdcore(3) .eq. 1) then
         sendd = .true.
      <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
         sendd = .false.
      endif

      n_blocks = <a class="el" href="../../d6/d4d/pio__internal_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(1,grid%geopkblocks)

      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (n_blocks &lt; jtot) then
         jblksiz = ceiling(float(jtot)/float(n_blocks))
         iblksiz = itot
      <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a> 
         jblksiz = 1
         iblksiz = ceiling(float(itot*jtot)/float(n_blocks))
      endif

      block = 0
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>=jfirst,jlast,jblksiz
         do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=ifirst,ilast,iblksiz
            block = block + 1
         enddo
      enddo

      allocate( sndreq(block) )
      allocate( rcvreq(block) )

      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (first_time_through .eq. 0) then
         first_time_through = 1
         k_pred_pid = -1
         k_succ_pid = -1
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
         klimits(1) = kfirst
         klimits(2) = klast
         call mpi_allgather (klimits, 2, mpi_integer, &amp;
                             klimits_all, 2, mpi_integer, &amp;
                             grid%comm_z, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
         do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=0,npr_z-1
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (klimits_all(2,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>) == kfirst-1) k_pred_pid = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (klimits_all(1,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>) == klast+1)  k_succ_pid = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>
         enddo
!endif
      endif

! top down

! prepost first <a class="el" href="../../db/d16/debug_8h.html#a48aad0e397ea504fdc3e57102ee2cb28">set</a> of receive requests
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_pred_pid /= -1) then
         block = 0
         do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>=jfirst,jlast,jblksiz
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+jblksiz &gt; jlast) then
               jb = jlast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+1
            <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
               jb = jblksiz
            endif

            do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=ifirst,ilast,iblksiz
               <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+iblksiz &gt; ilast) then
                  ib = ilast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+1
               <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
                  ib = iblksiz
               endif

               block = block + 1
               call mpi_irecv (l_pe(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,kfirst), jb*ib, &amp;
                               mpi_real8, k_pred_pid, block, &amp;
                               grid%comm_z, rcvreq(block), <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
            enddo
         enddo
      endif
!endif

      block = 0
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>=jfirst,jlast,jblksiz

         <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+jblksiz &gt; jlast) then
            jb = jlast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+1
         <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
            jb = jblksiz
         endif
         jlmax = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+jb-1

         do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=ifirst,ilast,iblksiz
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+iblksiz &gt; ilast) then
               ib = ilast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+1
            <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
               ib = iblksiz
            endif
            ilmax = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+ib-1

            block = block + 1

! get data from <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> predecessor
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_pred_pid /= -1) then
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
               call mpi_wait (rcvreq(block), status, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
!endif
            <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
               do jl=<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,jlmax
                  do il = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,ilmax
                     l_pe(il,jl,kfirst) = dp0_0
                  enddo
               enddo
            endif

! compute partial sums (note <a class="el" href="../../db/d16/debug_8h.html#a4fd82c6e74959ebd9393813b2ded4c7b">that</a> can <a class="el" href="../../d3/d3d/drifters__compute__k_8h.html#aaf68b4e8e89dfb379b579e345c00dbd0">not</a> thread over <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-loop)
            do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst+1,klast+1
               do jl=<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,jlmax
                  do il = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,ilmax
                     l_pe(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = l_pe(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1) + delp(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-1)
                  enddo
               enddo
            enddo

! send results to <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> successor
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_succ_pid /= -1) then
               <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (sendd) then
                  call mpi_send  (l_pe(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,klast+1), jb*ib, mpi_real8, &amp;
                                  k_succ_pid, block, grid%comm_z, &amp;
                                  <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
               <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
                  call mpi_isend (l_pe(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,klast+1), jb*ib, mpi_real8, &amp;
                                  k_succ_pid, block, grid%comm_z, &amp;
                                  sndreq(block), <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
               endif
            endif
!endif
!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(il, jl, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
            do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast+1
               do jl = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,jlmax
                  do il = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,ilmax
                     <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(il,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,jl) = l_pe(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) + ptop
                     pk(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#a3bdd9177fef31023437b720c7807e308">pe</a>(il,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>,jl) ** akap
                  enddo
               enddo
            enddo

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_succ_pid /= -1) then
               <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (.not. sendd) then
                  call mpi_wait (sndreq(block), status, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
               endif
            endif
!endif
         enddo
      enddo

! bottom up

! prepost second <a class="el" href="../../db/d16/debug_8h.html#a48aad0e397ea504fdc3e57102ee2cb28">set</a> of receive requests
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
      <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_succ_pid /= -1) then
         block = 0
         do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>=jfirst,jlast,jblksiz
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+jblksiz &gt; jlast) then
               jb = jlast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+1
            <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
               jb = jblksiz
            endif

            do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=ifirst,ilast,iblksiz
               <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+iblksiz &gt; ilast) then
                  ib = ilast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+1
               <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
                  ib = iblksiz
               endif

               block = block + 1
               call mpi_irecv (l_pe(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,klast+1), jb*ib, &amp;
                               mpi_real8, k_succ_pid, block, &amp;
                               grid%comm_z, rcvreq(block), <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
            enddo
         enddo
      endif
!endif

      block = 0
      do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>=jfirst,jlast,jblksiz

         <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+jblksiz &gt; jlast) then
            jb = jlast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+1
         <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
            jb = jblksiz
         endif
         jlmax = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>+jb-1

         do <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>=ifirst,ilast,iblksiz
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+iblksiz &gt; ilast) then
               ib = ilast-<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+1
            <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
               ib = iblksiz
            endif
            ilmax = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>+ib-1

            block = block + 1

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(il, jl, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
            do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast
               do jl=<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,jlmax
                  do il = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,ilmax
                     l_delp(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = &amp;
                        cp*pt(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)*(pk(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>+1)-pk(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>))
                  enddo
               enddo
            enddo

! get data from <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> predecessor
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_succ_pid /= -1) then
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
               call mpi_wait (rcvreq(block), status, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
!endif
            <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
               do jl=<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,jlmax
                  do il = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,ilmax
                     l_pe(il,jl,klast+1) = dp0_0
                  enddo
               enddo
            endif

! compute partial sums (note <a class="el" href="../../db/d16/debug_8h.html#a4fd82c6e74959ebd9393813b2ded4c7b">that</a> can <a class="el" href="../../d3/d3d/drifters__compute__k_8h.html#aaf68b4e8e89dfb379b579e345c00dbd0">not</a> thread over <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>-loop)
            do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = klast,kfirst,-1
               do jl=<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,jlmax
                  do il = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,ilmax
                     l_pe(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = l_pe(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>+1) + l_delp(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
                  enddo
               enddo
            enddo

! send results to <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> predecessor
!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_pred_pid /= -1) then
               <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (sendd) then
                  call mpi_send  (l_pe(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,kfirst), jb*ib, mpi_real8, &amp;
                                  k_pred_pid, block, &amp;
                                  grid%comm_z, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
               <a class="el" href="../../df/d2e/verif_a_e_8m.html#ac2e9d8f106c9b9c0028392683978b0e5">else</a>
                  call mpi_isend (l_pe(<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,kfirst), jb*ib, mpi_real8, &amp;
                                  k_pred_pid, block, &amp;
                                  grid%comm_z, sndreq(block), <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
               endif
            endif
!endif

!$omp  parallel do      &amp;
!$omp  default(shared)  &amp;
!$omp  private(il, jl, <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>)
            do <a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a> = kfirst,klast+1
               do jl=<a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#aa70273ff79c4879ed4bd07b1787dfd11">j</a>,jlmax
                  do il = <a class="el" href="../../d2/d1c/mpp__do__redistribute_8h.html#af188112545a45ebe3b3a60cb7cc1b1c0">i</a>,ilmax
                     wz(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) = l_pe(il,jl,<a class="el" href="../../da/dae/verif_d_8m.html#a1c73327b2882639bc9f5e416bb3cc7ac">k</a>) + hs(il,jl)
                  enddo
               enddo
            enddo

!<a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> defined (spmd)
            <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (k_pred_pid /= -1) then
               <a class="el" href="../../db/d50/mpi_8c.html#a163eccda569402d936363f51d62cfba0">if</a> (.not. sendd) then
                  call mpi_wait (sndreq(block), status, <a class="el" href="../../d1/dcd/collective_8c.html#a47ff74d6350a34e203f72b1c7777a3b2">ierror</a>)
               endif
            endif
!endif

         enddo

      enddo

      deallocate( sndreq )
      deallocate( rcvreq )&#160;</td>
          <td class="paramname"><em>cp3v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>cap3v</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d9/d4a/mpp__update__nest__domains_8h.html#a2f1a7b191d819194cc881180b9fa006b">integer</a>&#160;</td>
          <td class="paramname"><em>nx</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="https://drive.google.com/uc?id=1AGFXVg3FDBpGXyzSaW2Nz9mzCx-HLQG8" border="0" usemap="#ad1/dbd/geopk_8_f90_a26e0c5d8cc5d1b61ea961689c9bf8239_icgraph" alt=""/></div>
<map name="ad1/dbd/geopk_8_f90_a26e0c5d8cc5d1b61ea961689c9bf8239_icgraph" id="ad1/dbd/geopk_8_f90_a26e0c5d8cc5d1b61ea961689c9bf8239_icgraph">
<area shape="rect" title=" " alt="" coords="663,116,720,141"/>
<area shape="rect" href="../../dc/d41/cd__core_8_f90.html#a421e9e16f52ddba250a7a5688ef85d31" title=" " alt="" coords="497,89,565,115"/>
<area shape="rect" href="../../db/de2/namespacedyn__core__mod.html#abcb4c3aab58c1fb8db7655b709f352cc" title=" " alt="" coords="447,140,615,165"/>
<area shape="rect" href="../../d2/d1b/namespacedyn__comp.html#afbb049de545cf9616f4b5dd123485266" title=" " alt="" coords="257,55,393,80"/>
<area shape="rect" href="../../df/d4c/namespacestepon.html#a01bb71ea1f08d55873325239a7471ac5" title=" " alt="" coords="35,5,175,31"/>
<area shape="rect" href="../../df/d4c/namespacestepon.html#a566dfddd5e11409892bde5decb201266" title=" " alt="" coords="35,55,175,80"/>
<area shape="rect" href="../../db/d8c/namespacefv__dynamics__mod.html#a57030300ce6aacf81a3588faf906f07f" title=" " alt="" coords="252,137,399,177"/>
<area shape="rect" href="../../d5/df8/namespaceatmosphere__mod.html#a9dff78295a0b7ca403fc4b66adecfe96" title="The subroutine &#39;atmosphere_dynamics&#39; is an API for the main driver of the FV3 dynamical core responsi..." alt="" coords="5,105,204,145"/>
<area shape="rect" href="../../d5/df8/namespaceatmosphere__mod.html#a44ef1921c91b506dfc907a51e58e8e76" title="The subroutine &#39;atmospehre_state_update&#39; is an API to apply tendencies and compute a consistent progn..." alt="" coords="5,169,204,209"/>
<area shape="rect" href="../../d2/d1b/namespacedyn__comp.html#a27e8a98048bd96e53b2568ddd10e322c" title=" " alt="" coords="37,233,173,259"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
